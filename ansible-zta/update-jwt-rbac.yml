---
# Update entire ZTA stack with JWT-based RBAC
# 1. Auth Portal generates JWT with role claim
# 2. AWS Gateway (OPA) validates JWT and checks role
# 3. OS Cluster access only allowed for 'full_access' role

- name: Update Auth Portal with JWT Generation
  hosts: vm-auth-portal
  become: yes
  vars:
    auth_portal_ip: "{{ ansible_host }}"
    aws_gateway_ip: "10.20.2.5"
    os_gateway_ip: "10.10.2.5"
    # Zero Trust: Monitoring has NO public IP
    monitoring_internal_ip: "10.40.1.10"
    # JWT Secret - in production use proper key management
    jwt_secret: "zta-multicloud-secret-key-2026"
  tasks:
    - name: Create Auth Portal with JWT generation
      copy:
        dest: /opt/auth-portal/index.html
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ZTA Auth Portal</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                color: #fff;
              }
              .container {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 40px;
                width: 100%;
                max-width: 480px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
              }
              h1 {
                text-align: center;
                margin-bottom: 10px;
                font-size: 1.8rem;
                background: linear-gradient(90deg, #00d4ff, #7c3aed);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              .subtitle { text-align: center; color: #a0aec0; margin-bottom: 25px; font-size: 0.9rem; }
              .badge {
                display: inline-block;
                background: #7c3aed;
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 0.75rem;
                margin-bottom: 15px;
              }
              .hub-info {
                background: rgba(0, 212, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 12px;
                margin-bottom: 20px;
                text-align: center;
                font-size: 0.85rem;
                color: #a0aec0;
              }
              .form-group { margin-bottom: 18px; }
              label { display: block; margin-bottom: 6px; color: #e2e8f0; font-size: 0.9rem; }
              input {
                width: 100%;
                padding: 12px 14px;
                border: 2px solid rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                background: rgba(255, 255, 255, 0.05);
                color: #fff;
                font-size: 1rem;
                transition: all 0.3s;
              }
              input:focus { outline: none; border-color: #7c3aed; background: rgba(255, 255, 255, 0.1); }
              .btn {
                width: 100%;
                padding: 14px;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
              }
              .btn-primary { background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white; }
              .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4); }
              .error-msg {
                background: rgba(239, 68, 68, 0.2);
                border: 1px solid #ef4444;
                color: #fca5a5;
                padding: 10px;
                border-radius: 8px;
                margin-bottom: 15px;
                text-align: center;
                display: none;
              }
              .success-msg {
                background: rgba(16, 185, 129, 0.2);
                border: 1px solid #10b981;
                color: #6ee7b7;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 15px;
                display: none;
              }
              .users-hint {
                margin-top: 20px;
                padding: 15px;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 10px;
              }
              .users-hint h4 { color: #7c3aed; margin-bottom: 10px; font-size: 0.9rem; }
              .user-item {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                font-size: 0.8rem;
              }
              .user-item:last-child { border-bottom: none; }
              .user-role { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }
              .role-aws { background: #ff9900; color: #000; }
              .role-full { background: #10b981; color: #fff; }
              .role-monitor { background: #3b82f6; color: #fff; }
              .footer { text-align: center; margin-top: 20px; color: #64748b; font-size: 0.75rem; }
              .jwt-display {
                background: rgba(0,0,0,0.3);
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                word-break: break-all;
                font-family: monospace;
                font-size: 0.7rem;
                max-height: 100px;
                overflow-y: auto;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div style="text-align: center;"><span class="badge">üîí Zero Trust Architecture</span></div>
              <h1>üõ°Ô∏è Auth Portal</h1>
              <p class="subtitle">Hub-and-Spoke Single Entry Point</p>
              
              <div class="hub-info">
                üåê All traffic routes through this portal<br>
                JWT tokens control access to backend services
              </div>
              
              <div id="errorMsg" class="error-msg"></div>
              <div id="successMsg" class="success-msg"></div>
              
              <form id="loginForm">
                <div class="form-group">
                  <label>üë§ Username</label>
                  <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                  <label>üîë Password</label>
                  <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary">üîê Login & Get JWT</button>
              </form>
              
              <div class="users-hint">
                <h4>üìã Demo Accounts</h4>
                <div class="user-item">
                  <span><code>aws_user</code> / <code>aws123</code></span>
                  <span class="user-role role-aws">AWS Only</span>
                </div>
                <div class="user-item">
                  <span><code>full_user</code> / <code>full123</code></span>
                  <span class="user-role role-full">AWS + OS</span>
                </div>
                <div class="user-item">
                  <span><code>monitor</code> / <code>monitor123</code></span>
                  <span class="user-role role-monitor">Monitoring</span>
                </div>
              </div>
              
              <div class="footer">
                Auth Portal: {{ auth_portal_ip }} | Hub-and-Spoke ZTA
              </div>
            </div>
            
            <script>
              // Simple JWT encoder (for demo - production should use proper signing)
              function base64url(str) {
                return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
              }
              
              function createJWT(payload) {
                const header = { alg: 'HS256', typ: 'JWT' };
                const headerB64 = base64url(JSON.stringify(header));
                const payloadB64 = base64url(JSON.stringify(payload));
                // In production, signature should be created server-side with secret
                const signature = base64url('signature-placeholder');
                return headerB64 + '.' + payloadB64 + '.' + signature;
              }
              
              const users = {
                'aws_user': { password: 'aws123', role: 'aws_only', name: 'AWS Operator', permissions: ['aws:read'] },
                'full_user': { password: 'full123', role: 'full_access', name: 'Full Access User', permissions: ['aws:read', 'os:read', 'os:fetch'] },
                'monitor': { password: 'monitor123', role: 'monitoring', name: 'Monitoring Admin', permissions: ['monitor:read'] }
              };
              
              document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorMsg = document.getElementById('errorMsg');
                const successMsg = document.getElementById('successMsg');
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                if (users[username] && users[username].password === password) {
                  const user = users[username];
                  const now = Math.floor(Date.now() / 1000);
                  
                  const payload = {
                    sub: username,
                    name: user.name,
                    role: user.role,
                    permissions: user.permissions,
                    iat: now,
                    exp: now + 900, // 15 minutes
                    iss: 'zta-auth-portal',
                    aud: 'zta-multicloud'
                  };
                  
                  const token = createJWT(payload);
                  
                  // Store in localStorage
                  localStorage.setItem('zta_jwt', token);
                  localStorage.setItem('zta_user', JSON.stringify(payload));
                  
                  successMsg.innerHTML = `
                    <strong>‚úÖ Login Successful!</strong><br>
                    <small>Role: ${user.role}</small><br>
                    <small>Permissions: ${user.permissions.join(', ')}</small>
                    <div class="jwt-display">${token}</div>
                    <br><small>Redirecting to dashboard...</small>
                  `;
                  successMsg.style.display = 'block';
                  
                  // Redirect based on role after 2 seconds
                  setTimeout(() => {
                    switch(user.role) {
                      case 'aws_only':
                      case 'full_access':
                        window.location.href = '/aws/';
                        break;
                      case 'monitoring':
                        window.location.href = '/dashboard/monitor';
                        break;
                    }
                  }, 2000);
                } else {
                  errorMsg.textContent = '‚ùå Invalid username or password';
                  errorMsg.style.display = 'block';
                }
              });
            </script>
          </body>
          </html>

    - name: Update Monitoring Dashboard (no change needed)
      copy:
        dest: /opt/auth-portal/dashboard-monitor.html
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Monitoring Dashboard - ZTA</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                color: #fff;
              }
              .navbar {
                background: rgba(0, 0, 0, 0.3);
                padding: 15px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              .navbar h2 { color: #3b82f6; }
              .user-info { display: flex; align-items: center; gap: 15px; }
              .user-badge { background: #3b82f6; color: #fff; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; }
              .logout-btn {
                background: rgba(239, 68, 68, 0.2);
                border: 1px solid #ef4444;
                color: #fca5a5;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
              }
              .content { padding: 30px; max-width: 1200px; margin: 0 auto; }
              .services { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
              .service-card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(59, 130, 246, 0.3);
                border-radius: 15px;
                padding: 25px;
              }
              .service-btn {
                display: inline-block;
                padding: 10px 20px;
                border-radius: 8px;
                text-decoration: none;
                font-weight: 600;
                margin-top: 10px;
              }
              .btn-grafana { background: #f46800; color: #fff; }
              .btn-prometheus { background: #e6522c; color: #fff; }
              .btn-jaeger { background: #00bcd4; color: #fff; }
            </style>
          </head>
          <body>
            <nav class="navbar">
              <h2>üìä Monitoring Dashboard</h2>
              <div class="user-info">
                <span id="userName"></span>
                <span class="user-badge">Monitor Admin</span>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
              </div>
            </nav>
            <div class="content">
              <h1>Welcome to Monitoring</h1>
              <p>Access all observability tools via SSH tunnel (no public IP).</p>
              <div class="services">
                <div class="service-card">
                  <h3>üìà Grafana</h3>
                  <p>Metrics visualization</p>
                  <p style="font-size: 11px; color: #666;"><code>ssh -L 3000:10.40.1.10:3000 ubuntu@172.10.10.170</code></p>
                  <a href="http://localhost:3000" target="_blank" class="service-btn btn-grafana">Open Grafana (tunnel)</a>
                </div>
                <div class="service-card">
                  <h3>üî• Prometheus</h3>
                  <p>Metrics collection</p>
                  <p style="font-size: 11px; color: #666;"><code>ssh -L 9090:10.40.1.10:9090 ubuntu@172.10.10.170</code></p>
                  <a href="http://localhost:9090" target="_blank" class="service-btn btn-prometheus">Open Prometheus (tunnel)</a>
                </div>
                <div class="service-card">
                  <h3>üîç Jaeger</h3>
                  <p>Distributed tracing</p>
                  <p style="font-size: 11px; color: #666;"><code>ssh -L 16686:10.40.1.10:16686 ubuntu@172.10.10.170</code></p>
                  <a href="http://localhost:16686" target="_blank" class="service-btn btn-jaeger">Open Jaeger (tunnel)</a>
                </div>
              </div>
            </div>
            <script>
              const user = JSON.parse(localStorage.getItem('zta_user') || '{}');
              if (!user.role || user.role !== 'monitoring') {
                window.location.href = '/';
              }
              document.getElementById('userName').textContent = user.name || 'Unknown';
              function logout() { localStorage.clear(); window.location.href = '/'; }
            </script>
          </body>
          </html>

    - name: Restart auth-portal container
      docker_container:
        name: auth-portal
        state: absent
      ignore_errors: yes

    - name: Deploy updated Auth Portal
      docker_container:
        name: auth-portal
        image: nginx:alpine
        state: started
        restart_policy: always
        ports:
          - "80:80"
          - "8888:80"
        volumes:
          - /opt/auth-portal/index.html:/usr/share/nginx/html/index.html:ro
          - /opt/auth-portal/dashboard-monitor.html:/usr/share/nginx/html/dashboard-monitor.html:ro
          - /opt/auth-portal/nginx.conf:/etc/nginx/nginx.conf:ro

- name: Update AWS Gateway with JWT Role Checking
  hosts: vm-aws-gateway
  become: yes
  vars:
    os_gateway_ip: "10.10.2.5"
    auth_portal_ip: "172.10.10.170"
  tasks:
    - name: Create OPA Policy with Role-Based Access
      copy:
        dest: /opt/opa/policy.rego
        content: |
          package envoy.authz

          import future.keywords.if
          import future.keywords.in
          import input.attributes.request.http as http_request

          default allow = false

          # Public endpoints - no auth required
          allow if {
            http_request.method == "GET"
            http_request.path == "/"
          }

          allow if {
            http_request.method == "GET"
            startswith(http_request.path, "/static/")
          }

          allow if {
            http_request.path in ["/health", "/ready", "/live"]
          }

          # API endpoints require valid JWT with appropriate role
          allow if {
            startswith(http_request.path, "/api/")
            is_valid_token
            has_required_permission
          }

          # Parse JWT and validate
          is_valid_token if {
            auth_header := http_request.headers.authorization
            startswith(auth_header, "Bearer ")
            token := substring(auth_header, 7, -1)
            token != ""
            [header, payload, sig] := split(token, ".")
            payload_decoded := base64url_decode(payload)
            claims := json.unmarshal(payload_decoded)
            # Check expiration
            claims.exp > time.now_ns() / 1000000000
          }

          # Get claims from JWT
          claims := c if {
            auth_header := http_request.headers.authorization
            token := substring(auth_header, 7, -1)
            [_, payload, _] := split(token, ".")
            payload_decoded := base64url_decode(payload)
            c := json.unmarshal(payload_decoded)
          }

          # Check if user has required permission for the endpoint
          has_required_permission if {
            # /api/secure-data requires os:fetch permission (only full_access role)
            http_request.path == "/api/secure-data"
            "os:fetch" in claims.permissions
          }

          has_required_permission if {
            # /api/aws-data only requires aws:read permission
            http_request.path == "/api/aws-data"
            "aws:read" in claims.permissions
          }

          has_required_permission if {
            # /api/health accessible to all authenticated users
            http_request.path == "/api/health"
          }

          # Helper function to decode base64url
          base64url_decode(s) = decoded if {
            # Add padding if needed
            rem := count(s) % 4
            padding := substring("====", 0, (4 - rem) % 4)
            padded := concat("", [s, padding])
            # Replace URL-safe chars
            replaced := replace(replace(padded, "-", "+"), "_", "/")
            decoded := base64.decode(replaced)
          }

    - name: Create AWS UI with JWT-based authorization
      copy:
        dest: /opt/aws-frontend/index.html
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>AWS Cluster UI - Zero Trust</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                min-height: 100vh;
                padding: 20px;
                color: #e2e8f0;
              }
              .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 15px;
                margin-bottom: 20px;
              }
              .logo { display: flex; align-items: center; gap: 15px; }
              .logo h1 { font-size: 1.5rem; }
              .logo span { 
                background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 0.75rem;
                font-weight: 600;
              }
              .auth-status { display: flex; align-items: center; gap: 10px; }
              .status-dot { width: 12px; height: 12px; border-radius: 50%; }
              .status-dot.auth { background: #10b981; }
              .status-dot.unauth { background: #ef4444; }
              .user-info {
                background: rgba(124, 58, 237, 0.2);
                padding: 10px 15px;
                border-radius: 10px;
                margin-left: 15px;
              }
              .role-badge {
                display: inline-block;
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 0.7rem;
                margin-left: 5px;
              }
              .role-aws_only { background: #ff9900; color: #000; }
              .role-full_access { background: #10b981; color: #fff; }
              .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
              .card {
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 15px;
                padding: 25px;
              }
              .card h2 { margin-bottom: 15px; font-size: 1.2rem; }
              .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                margin: 5px;
              }
              .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
              .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
              .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
              .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
              .btn-disabled { background: #4b5563; color: #9ca3af; cursor: not-allowed; }
              .btn:hover:not(.btn-disabled) { transform: translateY(-2px); }
              .result-box {
                margin-top: 15px;
                padding: 15px;
                border-radius: 10px;
                font-family: monospace;
                font-size: 0.85rem;
                max-height: 300px;
                overflow-y: auto;
              }
              .result-box.success { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; }
              .result-box.error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; }
              .result-box.info { background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; }
              pre { white-space: pre-wrap; word-break: break-word; }
              .permission-note {
                background: rgba(251, 191, 36, 0.1);
                border: 1px solid #fbbf24;
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                font-size: 0.85rem;
              }
              .logout-btn {
                background: rgba(239, 68, 68, 0.2);
                border: 1px solid #ef4444;
                color: #fca5a5;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                margin-left: 10px;
              }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="logo">
                <h1>‚òÅÔ∏è AWS Cluster UI</h1>
                <span>Zero Trust</span>
              </div>
              <div class="auth-status">
                <div id="statusDot" class="status-dot unauth"></div>
                <span id="authLabel">Checking...</span>
                <div id="userInfo" class="user-info" style="display:none;">
                  <span id="userName"></span>
                  <span id="roleBadge" class="role-badge"></span>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ Logout</button>
              </div>
            </div>
            
            <div class="container">
              <div class="card">
                <h2>üìä AWS Local Data</h2>
                <p style="color:#a0aec0; margin-bottom:15px;">
                  Fetch data from AWS Cluster (local). Requires: <code>aws:read</code>
                </p>
                <button class="btn btn-primary" onclick="fetchAWSData()">Fetch AWS Data</button>
                <button class="btn btn-warning" onclick="fetchHealth()">Health Check</button>
                <div id="awsResult" class="result-box info">Results will appear here...</div>
              </div>
              
              <div class="card">
                <h2>üîó Cross-Cluster: OS Data</h2>
                <p style="color:#a0aec0; margin-bottom:15px;">
                  Fetch data from OS Cluster via Gateway. Requires: <code>os:fetch</code>
                </p>
                <button id="btnFetchOS" class="btn btn-success" onclick="fetchOSData()">Fetch OS Data</button>
                <div id="osPermissionNote" class="permission-note" style="display:none;">
                  ‚ö†Ô∏è Your role (<span id="currentRole"></span>) does not have <code>os:fetch</code> permission.<br>
                  Only <strong>full_access</strong> role can fetch cross-cluster data.
                </div>
                <div id="osResult" class="result-box info">Results will appear here...</div>
              </div>
            </div>
            
            <script>
              const AUTH_PORTAL = 'http://{{ auth_portal_ip }}';
              
              window.onload = checkAuthStatus;
              
              function checkAuthStatus() {
                const token = localStorage.getItem('zta_jwt');
                const user = JSON.parse(localStorage.getItem('zta_user') || '{}');
                const statusDot = document.getElementById('statusDot');
                const authLabel = document.getElementById('authLabel');
                const userInfo = document.getElementById('userInfo');
                const btnFetchOS = document.getElementById('btnFetchOS');
                const osPermissionNote = document.getElementById('osPermissionNote');
                
                if (token && user.role && isTokenValid(user)) {
                  statusDot.className = 'status-dot auth';
                  authLabel.textContent = 'Authenticated';
                  userInfo.style.display = 'block';
                  document.getElementById('userName').textContent = user.name;
                  document.getElementById('roleBadge').textContent = user.role;
                  document.getElementById('roleBadge').className = 'role-badge role-' + user.role;
                  
                  // Check OS fetch permission
                  if (!user.permissions || !user.permissions.includes('os:fetch')) {
                    btnFetchOS.className = 'btn btn-disabled';
                    btnFetchOS.onclick = null;
                    osPermissionNote.style.display = 'block';
                    document.getElementById('currentRole').textContent = user.role;
                  } else {
                    btnFetchOS.className = 'btn btn-success';
                    btnFetchOS.onclick = fetchOSData;
                    osPermissionNote.style.display = 'none';
                  }
                } else {
                  statusDot.className = 'status-dot unauth';
                  authLabel.textContent = 'Not Authenticated';
                  userInfo.style.display = 'none';
                  showResult('awsResult', 'error', '‚ùå Please login at Auth Portal first: ' + AUTH_PORTAL);
                }
              }
              
              function isTokenValid(user) {
                return user.exp && user.exp * 1000 > Date.now();
              }
              
              function logout() {
                localStorage.clear();
                window.location.href = AUTH_PORTAL;
              }
              
              async function fetchAWSData() {
                const token = localStorage.getItem('zta_jwt');
                if (!token) {
                  showResult('awsResult', 'error', '‚ùå No JWT token. Please login first.');
                  return;
                }
                
                showResult('awsResult', 'info', 'üîÑ Fetching AWS data...');
                
                try {
                  const res = await fetch('/api/aws-data', {
                    headers: { 'Authorization': 'Bearer ' + token }
                  });
                  
                  if (res.ok) {
                    const data = await res.json();
                    showResult('awsResult', 'success', '‚úÖ AWS Data:\n\n' + JSON.stringify(data, null, 2));
                  } else {
                    handleError('awsResult', res);
                  }
                } catch (err) {
                  showResult('awsResult', 'error', '‚ùå Network error: ' + err.message);
                }
              }
              
              async function fetchOSData() {
                const token = localStorage.getItem('zta_jwt');
                const user = JSON.parse(localStorage.getItem('zta_user') || '{}');
                
                if (!token) {
                  showResult('osResult', 'error', '‚ùå No JWT token. Please login first.');
                  return;
                }
                
                if (!user.permissions || !user.permissions.includes('os:fetch')) {
                  showResult('osResult', 'error', '‚ùå Permission Denied: Your role does not have os:fetch permission.');
                  return;
                }
                
                showResult('osResult', 'info', 'üîÑ Fetching OS data via Zero Trust pipeline...');
                
                try {
                  const res = await fetch('/api/secure-data', {
                    headers: { 'Authorization': 'Bearer ' + token }
                  });
                  
                  if (res.ok) {
                    const data = await res.json();
                    showResult('osResult', 'success', '‚úÖ OS Cluster Data (via Gateway):\n\n' + JSON.stringify(data, null, 2));
                  } else {
                    handleError('osResult', res);
                  }
                } catch (err) {
                  showResult('osResult', 'error', '‚ùå Network error: ' + err.message);
                }
              }
              
              async function fetchHealth() {
                showResult('awsResult', 'info', 'üîÑ Checking health...');
                try {
                  const res = await fetch('/health');
                  if (res.ok) {
                    showResult('awsResult', 'success', '‚úÖ AWS Gateway is healthy!');
                  } else {
                    showResult('awsResult', 'error', '‚ùå Health check failed: ' + res.status);
                  }
                } catch (err) {
                  showResult('awsResult', 'error', '‚ùå Health check failed: ' + err.message);
                }
              }
              
              function handleError(elementId, res) {
                if (res.status === 401) {
                  showResult(elementId, 'error', '‚ùå 401 Unauthorized: Token expired or invalid.\nPlease re-login.');
                  localStorage.clear();
                  checkAuthStatus();
                } else if (res.status === 403) {
                  showResult(elementId, 'error', '‚ùå 403 Forbidden: OPA policy denied.\nYour role lacks required permissions.');
                } else {
                  showResult(elementId, 'error', '‚ùå Error: HTTP ' + res.status);
                }
              }
              
              function showResult(elementId, type, message) {
                const box = document.getElementById(elementId);
                box.className = 'result-box ' + type;
                box.innerHTML = '<pre>' + message + '</pre>';
              }
            </script>
          </body>
          </html>

    - name: Create backend API server script
      copy:
        dest: /opt/aws-gateway/api-server.py
        content: |
          #!/usr/bin/env python3
          """
          AWS Gateway API Server with JWT validation
          Handles /api/* endpoints and proxies to OS Cluster
          """
          from http.server import HTTPServer, BaseHTTPRequestHandler
          import json
          import base64
          import time
          import urllib.request
          import urllib.error
          
          OS_GATEWAY = "http://{{ os_gateway_ip }}"
          
          class APIHandler(BaseHTTPRequestHandler):
              def do_GET(self):
                  if self.path == '/health':
                      self.send_json(200, {'status': 'healthy', 'service': 'aws-gateway'})
                  elif self.path == '/api/aws-data':
                      self.handle_aws_data()
                  elif self.path == '/api/secure-data':
                      self.handle_secure_data()
                  else:
                      self.send_json(404, {'error': 'Not found'})
              
              def handle_aws_data(self):
                  """Return AWS cluster local data - requires aws:read permission"""
                  claims = self.validate_token()
                  if not claims:
                      return
                  
                  if 'aws:read' not in claims.get('permissions', []):
                      self.send_json(403, {'error': 'Forbidden', 'message': 'aws:read permission required'})
                      return
                  
                  data = {
                      'source': 'aws-cluster',
                      'timestamp': time.strftime('%Y-%m-%dT%H:%M:%SZ'),
                      'user': claims.get('name'),
                      'role': claims.get('role'),
                      'data': {
                          'instances': ['web-1', 'web-2', 'api-1'],
                          'region': 'us-east-1-simulated',
                          'status': 'running'
                      }
                  }
                  self.send_json(200, data)
              
              def handle_secure_data(self):
                  """Fetch data from OS Cluster - requires os:fetch permission"""
                  claims = self.validate_token()
                  if not claims:
                      return
                  
                  if 'os:fetch' not in claims.get('permissions', []):
                      self.send_json(403, {
                          'error': 'Forbidden',
                          'message': 'os:fetch permission required',
                          'your_role': claims.get('role'),
                          'your_permissions': claims.get('permissions', [])
                      })
                      return
                  
                  # Fetch from OS Cluster
                  try:
                      req = urllib.request.Request(f'{OS_GATEWAY}/api/data')
                      with urllib.request.urlopen(req, timeout=5) as resp:
                          os_data = json.loads(resp.read().decode())
                  except Exception as e:
                      os_data = {'error': str(e), 'fallback': True, 'message': 'OS Cluster unreachable'}
                  
                  data = {
                      'source': 'cross-cluster-fetch',
                      'timestamp': time.strftime('%Y-%m-%dT%H:%M:%SZ'),
                      'user': claims.get('name'),
                      'role': claims.get('role'),
                      'aws_gateway': 'verified',
                      'os_cluster_data': os_data
                  }
                  self.send_json(200, data)
              
              def validate_token(self):
                  """Validate JWT and return claims"""
                  auth = self.headers.get('Authorization', '')
                  if not auth.startswith('Bearer '):
                      self.send_json(401, {'error': 'Unauthorized', 'message': 'Bearer token required'})
                      return None
                  
                  token = auth[7:]
                  try:
                      parts = token.split('.')
                      if len(parts) != 3:
                          raise ValueError('Invalid token format')
                      
                      # Decode payload
                      payload = parts[1]
                      # Add padding
                      padding = 4 - len(payload) % 4
                      if padding != 4:
                          payload += '=' * padding
                      payload = payload.replace('-', '+').replace('_', '/')
                      claims = json.loads(base64.b64decode(payload))
                      
                      # Check expiration
                      if claims.get('exp', 0) < time.time():
                          self.send_json(401, {'error': 'Unauthorized', 'message': 'Token expired'})
                          return None
                      
                      return claims
                  except Exception as e:
                      self.send_json(401, {'error': 'Unauthorized', 'message': f'Invalid token: {str(e)}'})
                      return None
              
              def send_json(self, status, data):
                  self.send_response(status)
                  self.send_header('Content-Type', 'application/json')
                  self.send_header('Access-Control-Allow-Origin', '*')
                  self.end_headers()
                  self.wfile.write(json.dumps(data).encode())
              
              def log_message(self, format, *args):
                  print(f"[API] {args[0]}")
          
          if __name__ == '__main__':
              server = HTTPServer(('0.0.0.0', 8080), APIHandler)
              print('API Server running on port 8080...')
              server.serve_forever()
        mode: '0755'

    - name: Create Dockerfile for API server
      copy:
        dest: /opt/aws-gateway/Dockerfile.api
        content: |
          FROM python:3.11-alpine
          WORKDIR /app
          COPY api-server.py .
          EXPOSE 8080
          CMD ["python", "api-server.py"]

    - name: Build API server image
      shell: |
        cd /opt/aws-gateway
        docker build -t aws-api-server -f Dockerfile.api .
      args:
        creates: /opt/aws-gateway/.api-built

    - name: Mark API as built
      file:
        path: /opt/aws-gateway/.api-built
        state: touch

    - name: Update nginx config for API routing
      copy:
        dest: /opt/aws-gateway/nginx.conf
        content: |
          events {
              worker_connections 1024;
          }
          http {
              include /etc/nginx/mime.types;
              
              upstream api_backend {
                  server host.docker.internal:8080;
              }
              
              server {
                  listen 80;
                  
                  location / {
                      root /usr/share/nginx/html;
                      index index.html;
                  }
                  
                  location /api/ {
                      proxy_pass http://172.17.0.1:8080;
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                      proxy_set_header Authorization $http_authorization;
                  }
                  
                  location /health {
                      proxy_pass http://172.17.0.1:8080/health;
                  }
              }
          }

    - name: Stop existing containers
      shell: docker stop aws-frontend aws-api 2>/dev/null || true && docker rm aws-frontend aws-api 2>/dev/null || true

    - name: Start API server
      docker_container:
        name: aws-api
        image: aws-api-server
        state: started
        restart_policy: always
        network_mode: host

    - name: Start frontend nginx
      docker_container:
        name: aws-frontend
        image: nginx:alpine
        state: started
        restart_policy: always
        ports:
          - "80:80"
        volumes:
          - /opt/aws-frontend/index.html:/usr/share/nginx/html/index.html:ro
          - /opt/aws-gateway/nginx.conf:/etc/nginx/nginx.conf:ro

    - name: Restart OPA with updated policy
      shell: docker restart opa
      ignore_errors: yes

- name: Update OS Gateway API
  hosts: vm-os-gateway
  become: yes
  tasks:
    - name: Create OS API response endpoint
      copy:
        dest: /opt/os-gateway/api-server.py
        content: |
          #!/usr/bin/env python3
          from http.server import HTTPServer, BaseHTTPRequestHandler
          import json
          import time
          
          class OSAPIHandler(BaseHTTPRequestHandler):
              def do_GET(self):
                  if self.path in ['/api/data', '/api/secure-data']:
                      data = {
                          'source': 'os-cluster',
                          'timestamp': time.strftime('%Y-%m-%dT%H:%M:%SZ'),
                          'data': {
                              'servers': ['os-node-1', 'os-node-2', 'os-node-3'],
                              'storage': '500GB available',
                              'network': 'net-cloud-os (10.10.2.0/24)'
                          }
                      }
                      self.send_json(200, data)
                  elif self.path == '/health':
                      self.send_json(200, {'status': 'healthy', 'service': 'os-gateway'})
                  else:
                      self.send_json(404, {'error': 'Not found'})
              
              def send_json(self, status, data):
                  self.send_response(status)
                  self.send_header('Content-Type', 'application/json')
                  self.send_header('Access-Control-Allow-Origin', '*')
                  self.end_headers()
                  self.wfile.write(json.dumps(data).encode())
              
              def log_message(self, format, *args):
                  print(f"[OS-API] {args[0]}")
          
          if __name__ == '__main__':
              server = HTTPServer(('0.0.0.0', 80), OSAPIHandler)
              print('OS API Server running on port 80...')
              server.serve_forever()
        mode: '0755'

    - name: Stop existing OS gateway
      shell: docker stop os-frontend 2>/dev/null || true && docker rm os-frontend 2>/dev/null || true
      ignore_errors: yes

    - name: Start OS API server
      docker_container:
        name: os-api
        image: python:3.11-alpine
        state: started
        restart_policy: always
        ports:
          - "80:80"
        volumes:
          - /opt/os-gateway/api-server.py:/app/api-server.py:ro
        command: python /app/api-server.py

    - name: Wait for OS API
      wait_for:
        port: 80
        delay: 3
        timeout: 30

- name: Display final info
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Show access info
      debug:
        msg: |
          ========================================
          ZTA with JWT-based RBAC Ready!
          ========================================
          
          Auth Portal: http://172.10.10.170
          
          Accounts:
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Username   ‚îÇ Password ‚îÇ Role        ‚îÇ Permissions         ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ aws_user   ‚îÇ aws123   ‚îÇ aws_only    ‚îÇ aws:read            ‚îÇ
          ‚îÇ full_user  ‚îÇ full123  ‚îÇ full_access ‚îÇ aws:read, os:fetch  ‚îÇ
          ‚îÇ monitor    ‚îÇ monitor123‚îÇ monitoring ‚îÇ monitor:read        ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          
          Flow:
          1. Login at Auth Portal ‚Üí Get JWT with role
          2. AWS UI reads JWT ‚Üí Shows available actions
          3. API calls include JWT ‚Üí Gateway validates
          4. OPA checks role/permissions ‚Üí Allow/Deny
          
          Test:
          - aws_user: Can fetch AWS data, CANNOT fetch OS data
          - full_user: Can fetch BOTH AWS and OS data
          ========================================
